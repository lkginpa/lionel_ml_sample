angular.module("sample",["ngRoute","ngCkeditor","sample.user","sample.search","sample.common","sample.detail","ui.bootstrap","ngJsonExplorer","sample.create"]).config(["$routeProvider","$locationProvider",function(e,t){"use strict";t.html5Mode(!0),e.when("/",{templateUrl:"/search/search.html"}).when("/create",{templateUrl:"/create/create.html",controller:"CreateCtrl"}).when("/detail",{templateUrl:"/detail/detail.html",controller:"DetailCtrl"}).when("/profile",{templateUrl:"/user/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/"})}]);var module=angular.module("sample.common",[]);module.filter("object2Array",function(){return function(e){var t=[];for(var r in e)e[r].__key=r,t.push(e[r]);return t}}),angular.module("sample.create").directive("compile",function(e){"use strict";return function(t,r,n){t.$watch(function(e){return e.$eval(n.compile)},function(n){r.html(n),e(r.contents())(t)})}}),function(){"use strict";angular.module("sample.create").controller("CreateCtrl",["$scope","MLRest","$window","User",function(e,t,r,n){var a={study:{studyName:"",protocol:"",clinics:[],paymentSchedules:[]},newClinic:{clinicName:"",clinicNumber:0,addr1:"",addr2:"",city:"",state:"",postalCode:"",investigatorFirstName:"",investigatorLastName:"",investigatorNPI:""},user:n},o=1;angular.extend(e,{model:a,editorOptions:{height:"100px",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align","bidi"]},{name:"links"}],toolbar:"",toolbar_full:""},submit:function(){t.createDocument(e.model.study,{format:"json",directory:"/content/",extension:".json"}).then(function(e){r.location.href="/detail?uri="+e.headers("location").replace(/(.*\?uri=)/,"")})},addClinic:function(){a.newClinic.clinicNumber=o++,a.study.clinics.push(a.newClinic),a.newClinic=""},removeClinic:function(e){a.study.clinics=a.study.clinics.filter(function(t){return t.clinicNumber!==e.clinicNumber})}})}])}(),angular.module("sample.create",[]),function(){"use strict";angular.module("sample.detail").controller("DetailCtrl",["$scope","MLRest","$routeParams","$window",function(e,t,r,n){var a=r.uri,o={detail:{}};t.getDocument(a,{format:"json"}).then(function(e){o.detail=e.data,n.console.log(o.detail)}),angular.extend(e,{model:o})}])}(),angular.module("sample.detail",[]),function(){"use strict";angular.module("sample.search").filter("object2Array",function(){return function(e){var t=[];for(var r in e)e[r].__key=r,t.push(e[r]);return t}}).directive("facets",[function(){return{restrict:"E",scope:{facets:"=facetList",selected:"=selected",select:"&select",clear:"&clear"},templateUrl:"/search/facets-dir.html",link:function(){}}}])}(),function(){"use strict";var e=angular.module("sample.search");e.directive("results",[function(){return{restrict:"E",scope:{results:"=resultList",total:"=total",start:"=start",pageLength:"=pageLength",currentPage:"=currentPage",paginate:"&paginate",updateQuery:"&updateQuery"},templateUrl:"/search/results-dir.html",link:function(e){e.Math=window.Math}}}])}(),function(){"use strict";angular.module("sample.search").controller("SearchCtrl",["$scope","MLRest","User","$location","$window",function(e,t,r,n,a){function o(e){a.console.log(e),a.console.log("selected:"),a.console.log(s.selected),s.search=e}var s={selected:[],text:"",user:r},u={queryOptions:["all"]},i=t.createSearchContext(u);!function(){i.search().then(o)}(),angular.extend(e,{model:s,selectFacet:function(e,t){a.console.log("select facet...");var r=s.selected.filter(function(r){return r.facet===e&&r.value===t});0===r.length&&(s.selected.push({facet:e,value:t}),i.selectFacet(e,t).search().then(o))},clearFacet:function(e,t){var r;for(r=0;r<s.selected.length;r++)if(s.selected[r].facet===e&&s.selected[r].value===t){s.selected.splice(r,1);break}i.clearFacet(e,t).search().then(o)},textSearch:function(){i.setText(s.text).search().then(o),n.path("/")},pageChanged:function(e){i.setPage(e,s.pageLength).search().then(o)},getSuggestions:function(e){return t.callExtension("extsuggest",{method:"GET",params:{"rs:pqtxt":e,"rs:options":"all"}}).then(function(e){return e.suggestions})}}),e.$watch("model.user.authenticated",function(e,t){i.search().then(o,function(e){s.search={}})})}])}(),angular.module("sample.search",[]),function(){"use strict";angular.module("sample.user").controller("ProfileCtrl",["$scope","MLRest","User","$location",function(e,t,r,n){var a={user:r,newEmail:""};angular.extend(e,{model:a,addEmail:function(){e.profileForm.newEmail.$error.email||(e.model.user.emails||(e.model.user.emails=[]),e.model.user.emails.push(a.newEmail),a.newEmail="")},removeEmail:function(t){e.model.user.emails.splice(t,1)},submit:function(){t.updateDocument({user:{fullname:e.model.user.fullname,emails:e.model.user.emails}},{format:"json",uri:"/users/"+e.model.user.name+".json"}).then(function(e){n.path("/")})}})}])}(),function(){"use strict";var e=angular.module("sample.user");e.directive("mlUser",[function(){return{restrict:"A",controller:"UserController",replace:!0,scope:{username:"=username",password:"=password",authenticated:"=authenticated",login:"&login",logout:"&logout",loginerror:"=loginerror"},templateUrl:"/user/user-dir.html",link:function(e){}}}]).controller("UserController",["$scope","User","$http","$location",function(e,t,r,n){angular.extend(e,{login:function(e,a){r.get("/user/login",{params:{username:e,password:a}}).then(function(e){t.authenticated=e.data.authenticated,t.authenticated===!0?(t.loginError=!1,void 0!==e.data.profile?(t.fullname=e.data.profile.fullname,t.emails=e.data.profile.emails):n.path("/profile")):t.loginError=!0})},logout:function(){r.get("/user/logout",{}).then(function(){t.init()})}})}])}(),function(){"use strict";angular.module("sample.user").factory("User",["$http",function(e){function t(e){var t=e.data;t.authenticated===!0&&(r.name=t.username,r.authenticated=!0,void 0!==t.profile&&(r.hasProfile=!0,r.fullname=t.profile.fullname,$.isArray(t.profile.emails)?r.emails=t.profile.emails:r.emails=[t.profile.emails]))}var r={};return e.get("/user/status",{}).then(t),r.init=function(){return r.name="",r.password="",r.loginError=!1,r.authenticated=!1,r.hasProfile=!1,r.fullname="",r.emails=[],r},r}])}(),angular.module("sample.user",["sample.common"]),function(){"use strict";angular.module("sample.common").provider("MLRest",function(){function e(e){var t,r,n,a,o=[],s={};for(var u in e)if(e.hasOwnProperty(u)){s={};for(a in e[u])if(e[u].hasOwnProperty(a))if("metadata"===a){t={};for(r in e[u].metadata)if(e[u].metadata.hasOwnProperty(r))for(n in e[u].metadata[r])e[u].metadata[r].hasOwnProperty(n)&&(t[n]?t[n].push(e[u].metadata[r][n]):t[n]=[e[u].metadata[r][n]]);s.metadata=t}else s[a]=e[u][a];o.push(s)}return o}function t(t,r,n){function a(){var a=r.defer();return n.get("/v1/search",{params:{format:"json",options:t.queryOptions,structuredQuery:s(),start:d,pageLength:t.pageLength}}).success(function(t){t.results=e(t.results),a.resolve(t)}).error(function(e){a.reject(e)}),a.promise}function o(e){var r;for(r in i)i.hasOwnProperty(r)&&i[r].length>0&&("Dataset"===r?e.push({"collection-constraint-query":{"constraint-name":"Dataset",uri:[i[r]]}}):void 0!==t.customConstraintNames&&t.customConstraintNames.indexOf(r)>-1?e.push({"custom-constraint-query":{"constraint-name":r,value:i[r]}}):e.push({"range-constraint-query":{"constraint-name":r,value:i[r]}}))}function s(){var e,r=[];return o(r),null!==l&&r.push({qtext:l}),e=u.length>0?{query:{queries:[{"boost-query":{"matching-query":{"and-query":{queries:r}},"boosting-query":{"and-query":{queries:u}}}}]}}:{query:{queries:[{"and-query":{queries:r}}]}},t.includeProperties&&(e={query:{queries:[{"or-query":{queries:[e,{"properties-query":e}]}}]}}),m&&e.query.queries.push({"operator-state":{"operator-name":"sort","state-name":m}}),c&&e.query.queries.push({"operator-state":{"operator-name":"results","state-name":c}}),e}t=t||{};var u=[],i={},l=null,c="compact",m=null,d=1;return function(){t.queryOptions=t.queryOptions?t.queryOptions:"all",t.pageLength=t.pageLength?t.pageLength:10}(),{selectFacet:function(e,t){return void 0===i.facet?i[e]=[t]:i[e].push(t),this},clearFacet:function(e,t){return i[e]=i[e].filter(function(e){return e!==t}),this},clearAllFacets:function(){return i={},this},getQueryOptions:function(){return t.queryOptions},getStructuredQuery:s,search:function(){return a()},setText:function(e){return l=""!==e?e:null,this},setPage:function(e){return d=1+(e-1)*t.pageLength,this},sortBy:function(e){return m=e,this}}}this.$get=function(e,r){var n={createSearchContext:function(n){return new t(n,e,r)},getDocument:function(e,t){return(void 0===t||null===t)&&(t={}),angular.extend(t,{format:"json",uri:e}),r.get("/v1/documents",{params:t})},createDocument:function(e,t){return r.post("/v1/documents",e,{params:t})},updateDocument:function(t,n){var a=e.defer();return r.put("/v1/documents",t,{params:n}).success(function(e,t,r,n){a.resolve(r("location"))}).error(function(e){a.reject(e)}),a.promise},patch:function(t,n){var a=e.defer();return r.post("/v1/documents",n,{params:{uri:t},headers:{"X-HTTP-Method-Override":"PATCH","Content-Type":"application/json"}}).success(function(e,t,r,n){a.resolve(r("location"))}).error(function(e){a.reject(e)}),a.promise},advancedCall:function(t,n){var a=e.defer(),o=n.method,s="GET"===o||"PUT"===o||"POST"===o||"DELETE"===o;return o=s?o:"POST",s||(n.headers=n.headers||{},n.headers["X-HTTP-Method-Override"]=n.method),r({url:t,data:n.data,method:o,params:n.params,headers:n.headers}).success(function(e,t,r,n){a.resolve(e)}).error(function(e){a.reject(e)}),a.promise},callExtension:function(e,t){return this.advancedCall("/v1/resources/"+e,t)}};return n}})}();